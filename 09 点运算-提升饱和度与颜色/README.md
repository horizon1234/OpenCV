# 课程 09：点运算——提升饱和度与颜色调整

> 适合人群：零基础初学者 | 预计阅读时间：25 分钟

---

## 一、本课目标

本课你将学会：

1. 理解 **HSV 色彩空间** 及其与 BGR 的区别
2. 通过操作 **饱和度（S）通道** 让画面更鲜艳
3. 直接操作 **BGR 通道** 调整色彩偏向（红增蓝减）
4. 掌握 `cv::cvtColor`、`cv::split`、`cv::merge` 的用法

---

## 二、色彩空间基础

### 2.1 什么是色彩空间？

色彩空间是**描述颜色的坐标系**，不同坐标系适合不同任务。

```
 BGR（OpenCV 默认）              HSV（色相-饱和度-明度）
┌──────────────────┐          ┌──────────────────┐
│  B = 蓝色通道     │          │  H = 色相 (Hue)    │   ← 什么颜色
│  G = 绿色通道     │          │  S = 饱和度 (Sat)   │   ← 多鲜艳
│  R = 红色通道     │          │  V = 明度 (Value)   │   ← 多亮
└──────────────────┘          └──────────────────┘
  适合：硬件显示                 适合：颜色分析/调整
```

### 2.2 HSV 色彩空间详解

```
         色相 H（Hue）
         ──────────────
         OpenCV 范围：0 ~ 179（将 0°~360° 映射到 0~179）

         0°/360° ──── 红色
           ╱    ╲
         60°     300° ── 品红
        黄色       ╲
       ╱            270° ── 蓝紫
     120°              │
     绿色            240° ── 蓝色
       ╲              │
        180° ──── 青色
              200°

  色相环（6 种主色）：
     H=0    →  红 🔴
     H=30   →  橙 🟠
     H=60   →  黄 🟡
     H=90   →  绿 🟢
     H=120  →  青 🔵     （OpenCV 中 H 要 ÷2）
     H=150  →  蓝紫 🟣

  注意：OpenCV 用 uint8 存储，所以 H 范围 0~179 而非 0~359
        H=0 和 H=180 都是红色（环形）
```

#### HSV 色相值速查表

| 颜色 | 标准角度(0°~360°) | OpenCV H值(0~179) | BGR 近似值 | 调色用途 |
|:----:|:----------------:|:-----------------:|:----------:|:-------:|
| 🔴 红 | 0° / 360° | **0** / **180** | (0,0,255) | 肤色、火焰 |
| 🟠 橙 | 30° | **15** | (0,165,255) | 暖色调 |
| 🟡 黄 | 60° | **30** | (0,255,255) | 高光、阳光 |
| 🟢 绿 | 120° | **60** | (0,255,0) | 植被、自然 |
| 🔵 青 | 180° | **90** | (255,255,0) | 天空、水面 |
| 🔵 蓝 | 240° | **120** | (255,0,0) | 冷色调 |
| 🟣 紫 | 300° | **150** | (255,0,255) | 特效 |

> 📐 换算公式：OpenCV_H = 标准角度 ÷ 2（因为 360°→180 才能塞进 uint8）

```
  饱和度 S（Saturation）     明度 V（Value）
  ────────────────────      ────────────────

  S = 0（无饱和度）          V = 0（无明度）
    = 灰色                  = 黑色
  ┌──────────┐              ┌──────────┐
  │ 灰蒙蒙的  │              │ 全黑      │
  └──────────┘              └──────────┘

  S = 255（满饱和度）        V = 255（最亮）
    = 纯色，非常鲜艳         = 最亮
  ┌──────────┐              ┌──────────┐
  │ 鲜艳夺目！│              │ 最亮的颜色 │
  └──────────┘              └──────────┘
```

### 2.3 HSV 的立体模型

```
  HSV 可视化为一个圆锥体：

          明度 V
           ↑
      255  │    ╭─────╮     ← 色相 H 绕圈
           │  ╭─┤ 彩色 ├─╮  ← 饱和度 S 从中心到外
           │  │ ╰─────╯ │      心：灰色（S=0）
           │  ╰────┬────╯      边缘：纯色（S=255）
           │       │
           │   ╭───╮
           │   │灰白│
        0  │   ╰───╯
           └────────────▶

  顶部圆面：V=255, 中心为白色, 外圈为纯色
  底部尖点：V=0, 黑色（无论 H 和 S 为何）
```

---

## 三、BGR 通道与颜色的关系

### 3.1 三通道混合

```
  BGR 三通道如何合成颜色：

    B=255, G=0,   R=0   →  纯蓝 🔵
    B=0,   G=255, R=0   →  纯绿 🟢
    B=0,   G=0,   R=255 →  纯红 🔴
    B=255, G=255, R=0   →  青色
    B=0,   G=255, R=255 →  黄色
    B=255, G=0,   R=255 →  品红
    B=255, G=255, R=255 →  白色
    B=0,   G=0,   R=0   →  黑色
```

### 3.2 通道增强/减弱的效果

```
  原图某像素：B=100, G=120, R=80

  红色通道 ×1.2:  B=100, G=120, R=96    →  画面偏暖（红色增强）
  蓝色通道 ×0.8:  B=80,  G=120, R=80    →  画面偏暖（蓝色减弱）
  两者叠加:       B=80,  G=120, R=96    →  明显偏暖

  直觉理解：
    增加红色 + 减少蓝色 = 暖色调（类似"日落滤镜"）
    增加蓝色 + 减少红色 = 冷色调（类似"冰冷滤镜"）
```

#### 色彩调整预设速查表

| 效果名称 | B 通道 | G 通道 | R 通道 | 视觉感受 |
|:-------:|:------:|:------:|:------:|:-------:|
| 日落暖调 | ×0.8 | 不变 | ×1.2 | 🌅 偏橙红，温暖 |
| 冰冷蓝调 | ×1.2 | 不变 | ×0.8 | 🧊 偏蓝，冷峻 |
| 怀旧复古 | ×0.9 | ×1.1 | ×1.1 | 📜 偏黄绿，旧照感 |
| 清新自然 | 不变 | ×1.15 | ×0.95 | 🌿 偏绿，通透 |
| 梦幻紫调 | ×1.1 | ×0.9 | ×1.1 | 💜 偏紫，奇幻 |
| 高饱和 | — | S×1.5 | — | 🎨 HSV法，色彩鲜艳 |
| 去饱和 | — | S×0.5 | — | 🌫️ HSV法，偏灰柔和 |

> 前 5 种直接操作 BGR 通道，后 2 种通过 HSV 的 S 通道实现。

---

## 四、核心 API

### 4.1 颜色空间转换

```cpp
cv::cvtColor(src, dst, cv::COLOR_BGR2HSV);  // BGR → HSV
cv::cvtColor(src, dst, cv::COLOR_HSV2BGR);  // HSV → BGR
```

```
常用转换码：
  COLOR_BGR2HSV     bgr → hsv
  COLOR_HSV2BGR     hsv → bgr
  COLOR_BGR2GRAY    bgr → 灰度
  COLOR_BGR2YCrCb   bgr → YCrCb（课程 07 用过）
  COLOR_BGR2Lab     bgr → Lab 色彩空间
```

### 4.2 通道拆分 / 合并

```cpp
std::vector<cv::Mat> channels;
cv::split(hsv, channels);     // 拆分：1个3通道 → 3个单通道
// channels[0] = H
// channels[1] = S  ← 我们要操作这个
// channels[2] = V

cv::merge(channels, hsv);     // 合并：3个单通道 → 1个3通道
```

```
split 示意图：

  ┌─────────────┐          ┌─────┐
  │  H  S  V    │  split   │  H  │  channels[0]
  │  H  S  V    │ ──────▶  ├─────┤
  │  H  S  V    │          │  S  │  channels[1]
  │  (3 通道)    │          ├─────┤
  └─────────────┘          │  V  │  channels[2]
                           └─────┘

  ┌─────┐
  │  H  │  channels[0]
  ├─────┤                  ┌─────────────┐
  │ S'  │  channels[1]    │  H  S' V    │
  ├─────┤  merge           │  H  S' V    │
  │  V  │  channels[2]    │  H  S' V    │
  └─────┘ ──────▶          │  (3 通道)    │
                           └─────────────┘
```

---

## 五、代码详解

### 5.1 完整处理流程

```
原图(BGR) ──▶ HSV 转换 ──▶ 拆分通道 ──▶ 饱和度+40 ──▶ 合并 ──▶ 转回BGR
                                                              │
                                                              ▼
原图(BGR) ──▶ 拆分BGR通道 ──▶ R通道×1.2, B通道×0.8 ──▶ 合并 ──▶ 最终结果
```

### 5.2 饱和度增强

```cpp
// 1. BGR → HSV
cv::Mat hsv;
cv::cvtColor(src, hsv, cv::COLOR_BGR2HSV);

// 2. 拆分 H, S, V
std::vector<cv::Mat> channels;
cv::split(hsv, channels);

// 3. 饱和度 +40（注意防溢出！）
channels[1].convertTo(channels[1], -1, 1.0, 40);
//                     类型不变 ^    缩放^  偏移^
//   公式：dst = src * 1.0 + 40 = src + 40
//   溢出自动截断到 [0, 255]

// 4. 合并 & 转回 BGR
cv::merge(channels, hsv);
cv::cvtColor(hsv, result, cv::COLOR_HSV2BGR);
```

### 5.3 为什么用 convertTo 而不是直接加？

```
直接加的问题——溢出：

  uint8 值 = 230
  230 + 40 = 270  →  溢出！ uint8 最大 255
  实际结果 = 270 % 256 = 14  →   完全错误！

  convertTo 会做饱和运算（saturate）：
  230 + 40 = 270  →  截断为 255  ✅ 正确

  ┌──────────────────────────────────────────┐
  │ 初学者常见 Bug：                          │
  │   channels[1] += 40;  ← 溢出！不要用！   │
  │   channels[1].convertTo(..., 1, 40); ✅   │
  └──────────────────────────────────────────┘
```

### 5.4 红增蓝减——BGR 通道调色

```cpp
// 拆分 BGR 通道
std::vector<cv::Mat> bgr;
cv::split(result, bgr);
// bgr[0] = B, bgr[1] = G, bgr[2] = R

// 红色通道 ×1.2（增强暖色）
bgr[2].convertTo(bgr[2], -1, 1.2, 0);
//                             ↑
//                    scale=1.2, offset=0
//                    dst = src * 1.2

// 蓝色通道 ×0.8（减弱冷色）
bgr[0].convertTo(bgr[0], -1, 0.8, 0);
//                             ↑
//                    scale=0.8, offset=0
//                    dst = src * 0.8

// 合并
cv::merge(bgr, result);
```

### 5.5 convertTo 公式

```
cv::Mat::convertTo(dst, rtype, alpha, beta)

公式：dst(x,y) = saturate_cast<rtype>( src(x,y) * alpha + beta )

参数表：
┌───────┬────────────────────────────────────────┐
│ rtype │ 输出类型，-1 表示与输入相同              │
│ alpha │ 缩放因子（乘法）                        │
│ beta  │ 偏移量（加法）                          │
└───────┴────────────────────────────────────────┘

本课用到的两种用法：

  饱和度 +40:  alpha=1.0, beta=40   →  dst = src * 1 + 40
  红 ×1.2:     alpha=1.2, beta=0    →  dst = src * 1.2
  蓝 ×0.8:     alpha=0.8, beta=0    →  dst = src * 0.8
```

#### convertTo 常见用法速查表

| 目的 | alpha | beta | 等效公式 | 课程 |
|:----:|:-----:|:----:|:-------:|:----:|
| 饱和度 +40 | 1.0 | 40 | dst = src + 40 | **09 本课** |
| 饱和度 ×1.5 | 1.5 | 0 | dst = src × 1.5 | **09 本课** |
| 红通道 ×1.2 | 1.2 | 0 | dst = src × 1.2 | **09 本课** |
| 反相 | -1.0 | 255 | dst = 255 - src | 10 反相 |
| 对比度拉伸 | 255/(max-min) | -min×α | dst = (src-min)×α | 12 拉伸 |
| 降低对比度 | 0.5 | 64 | dst = src×0.5 + 64 | — |
| 类型转换 | 1/255.0 | 0 | CV_8U→CV_32F 归一化 | — |

> `convertTo` 是 OpenCV 中最万能的"线性变换"工具，贯穿整个点运算系列！

---

## 六、像素级演算

### 6.1 饱和度增强前后对比

```
原像素（BGR）：B=120, G=80, R=180

步骤 1：BGR → HSV
  H = 10   (色相：偏红/橙)
  S = 130  (饱和度：中等)
  V = 180  (明度：较亮)

步骤 2：S + 40
  S = 130 + 40 = 170  ← 饱和度更高 → 更鲜艳

步骤 3：HSV → BGR
  B ≈ 92, G ≈ 47, R ≈ 180
  红色更纯，蓝绿成分减少 → 颜色更鲜艳
```

### 6.2 红增蓝减前后对比

```
上一步结果：B=92, G=47, R=180

红 ×1.2:  R = min(180 * 1.2, 255) = min(216, 255) = 216
蓝 ×0.8:  B = 92 * 0.8 = 73.6 → 74（取整）
绿不变:   G = 47

最终：B=74, G=47, R=216

对比：
  原始：  B=120, G= 80, R=180  （偏红但不太鲜艳）
  最终：  B= 74, G= 47, R=216  （鲜艳的暖红色！）
```

---

## 七、不同饱和度增量的效果

```
假设原始 S=100：

  S += 0    →  原图       □ 正常
  S += 20   →  略鲜艳     ▒ 微调
  S += 40   →  明显鲜艳   ▓ 本课设定
  S += 80   →  过饱和     █ 颜色不自然
  S += 155  →  全部 255   █ 严重失真

   S=0      S=100     S=140     S=180     S=255
   灰色     原图      +40       +80       纯色
   ░░░░     ▒▒▒▒     ▓▓▓▓     ████     ████
                       ↑
                   本课选择的增量
                   效果明显且自然
```

---

## 八、冷暖色调调节模板

```
暖色（日落/复古风）：             冷色（冰冷/清新风）：
  R × 1.2 ↑                      R × 0.8 ↓
  G × 1.0                        G × 1.0
  B × 0.8 ↓                      B × 1.2 ↑

  效果：                         效果：
  ┌──── 暖 ────┐                 ┌──── 冷 ────┐
  │  偏红偏黄   │                 │  偏蓝偏青   │
  │  温暖怀旧   │                 │  清凉通透   │
  └────────────┘                 └────────────┘

更多调色方案：
  方案          R      G      B
  ─────────────────────────────
  暖色调       ×1.2   ×1.0   ×0.8
  冷色调       ×0.8   ×1.0   ×1.2
  绿色风格     ×0.9   ×1.1   ×0.9
  复古胶片     ×1.1   ×1.0   ×0.9
  青橙互补     ×1.2   ×0.9   ×0.85
```

---

## 九、动手实验

### 实验 1：不同饱和度增量

修改饱和度偏移量，观察效果：
```cpp
int offsets[] = {-50, -20, 0, 20, 40, 80, 120};
for (int offset : offsets) {
    // ...
    channels[1].convertTo(channels[1], -1, 1.0, offset);
    // 负值 = 去饱和（变灰），正值 = 加饱和（更鲜艳）
}
```

### 实验 2：只做去饱和

```cpp
// 完全去饱和 = 灰度图！
channels[1] = cv::Scalar(0);  // S 全部设为 0
// HSV 中 S=0 意味着无彩色 → 灰度
```

### 实验 3：用乘法增强饱和度

```cpp
// 乘法比加法更自然：
channels[1].convertTo(channels[1], -1, 1.5, 0);
// dst = src * 1.5
// 原本饱和的更饱和，原本不饱和的增加较少
// 比统一 +40 更照顾不同区域的差异
```

---

## 十、常见问题

| 问题 | 原因 | 解决方法 |
|------|------|---------|
| 颜色失真、出现色斑 | 饱和度溢出（用了 += 而非 convertTo） | 使用 `convertTo` 做饱和运算 |
| 画面偏色严重 | 通道缩放因子太大 | 缩放因子保持在 0.7~1.3 范围 |
| 调色后变暗/变亮 | BGR 通道不均匀缩放影响亮度 | 在 HSV 中只调 S 不动 V |
| H 通道溢出导致色相突变 | H 范围 0~179 特殊处理 | 若调 H 需 % 180 取模 |
| split/merge 崩溃 | Mat 为空或通道数不对 | 确认 `src.channels() == 3` |

---

## 十一、术语表

| 术语 | 英文 | 含义 |
|------|------|------|
| 色相 | Hue | 颜色的种类（红/绿/蓝等） |
| 饱和度 | Saturation | 颜色的鲜艳程度 |
| 明度 | Value / Brightness | 颜色的明暗程度 |
| 色彩空间 | Color Space | 描述颜色的数学模型 |
| 通道 | Channel | 图像中存储某一颜色分量的矩阵 |
| 拆分 | Split | 将多通道图像分成多个单通道 |
| 合并 | Merge | 将多个单通道合成一个多通道图像 |
| 饱和运算 | Saturate Cast | 超出范围的值被截断到范围内 |
| 暖色调 | Warm Tone | 偏红偏黄的色调 |
| 冷色调 | Cool Tone | 偏蓝偏青的色调 |

---

## 十二、知识地图

```
  ⑥ Gamma → ⑦ 直方图 → ⑧ 截断 → ⑨ 颜色调整 → ⑩ 反相
                                    ★ 本课

  本课用到的技术：
  ├── cvtColor（课程 07 也用过 YCrCb 转换）
  ├── split / merge（课程 07 也用过）
  └── convertTo（课程 12 对比度拉伸也会用到）

  色彩空间知识路线：
  BGR 基础 → YCrCb(课程07) → HSV(本课) → Lab(延伸)
```

---

## 十三、记忆口诀

```
🧠 HSV 三要素：

  "H 定色，S 定艳，V 定亮"
  Hue = 什么颜色
  Saturation = 多鲜艳
  Value = 多亮

🧠 暖冷色调：

  "红增蓝减暖如火，蓝增红减冷如冰"
  暖色调: R×1.2, B×0.8
  冷色调: R×0.8, B×1.2

🧠 防溢出：

  "加值用 convertTo，手动加法会溢出"
  channels[1].convertTo(channels[1], -1, 1.0, 40);  ✅
  channels[1] += 40;  ❌ 溢出！
```

---

## 十四、新手雷区

```cpp
// ❌ 雷区 1：直接用 += 加饱和度
channels[1] += 40;
// uchar 溢出：230 + 40 = 270 % 256 = 14 → 完全错误！

// ✅ 正确：用 convertTo 做饱和运算
channels[1].convertTo(channels[1], -1, 1.0, 40);
// 230 + 40 = 270 → 截断为 255 ✅
```

```cpp
// ❌ 雷区 2：HSV 和 BGR 搞混
cv::split(bgrImage, channels);  // 这是 BGR 的通道！
channels[1].convertTo(channels[1], -1, 1.0, 40);  // 加的是 G 通道，不是 S！

// ✅ 正确：先转 HSV 再 split
cv::cvtColor(bgrImage, hsv, cv::COLOR_BGR2HSV);
cv::split(hsv, channels);  // 现在 channels[1] 才是 S
```

```cpp
// ❌ 雷区 3：H 通道也用加法修改
channels[0] += 30;  // H 范围是 0~179，加 30 可能溢出回绕！
// 160 + 30 = 190 → 超出范围

// ✅ 正确：H 通道修改需要取模
for (int i = 0; i < channels[0].total(); i++)
    channels[0].data[i] = (channels[0].data[i] + 30) % 180;
```

---

## 十五、思考题

1. **把饱和度 S 设为 0，整张图会变成什么样？**
   提示：HSV 中 S=0 意味着"无彩色"……

2. **为什么用乘法（×1.5）增强饱和度比加法（+40）更自然？**
   提示：乘法保持了原始比例，加法是统一偏移。

3. **如果想实现"老照片/复古"效果，应该怎么调 HSV？**
   提示：降低饱和度 + 偏暖色调 + 稍微降低对比度。

---

## 十六、速查卡片

```
┌─────────────────── 课程 09 速查 ───────────────────┐
│                                                    │
│  颜色空间转换:                                      │
│    cvtColor(src, dst, COLOR_BGR2HSV);              │
│    cvtColor(src, dst, COLOR_HSV2BGR);              │
│                                                    │
│  通道操作:                                          │
│    cv::split(img, channels);  // 拆分              │
│    cv::merge(channels, img);  // 合并              │
│                                                    │
│  饱和度增强（HSV 空间）:                             │
│    channels[1].convertTo(chs[1], -1, 1.0, +40);   │
│                                                    │
│  暖色调（BGR 空间）:                                 │
│    bgr[2].convertTo(bgr[2], -1, 1.2, 0);  // R↑   │
│    bgr[0].convertTo(bgr[0], -1, 0.8, 0);  // B↓   │
│                                                    │
│  HSV 通道: [0]=H色相 [1]=S饱和度 [2]=V明度          │
│  BGR 通道: [0]=B蓝   [1]=G绿     [2]=R红            │
│                                                    │
└────────────────────────────────────────────────────┘
```

---

## 十七、延伸阅读

- [cv::cvtColor 文档](https://docs.opencv.org/4.x/d8/d01/group__imgproc__color__conversions.html#ga397ae87e1288a81d2363b61574eb8cab) — 所有颜色空间转换
- [HSV 色彩空间详解](https://docs.opencv.org/4.x/df/d9d/tutorial_py_colorspaces.html) — OpenCV 官方色彩空间教程
- [Mat::convertTo 文档](https://docs.opencv.org/4.x/d3/d63/classcv_1_1Mat.html#adf88c60c5b4980e05bb556080916978b) — 缩放+偏移+饱和截断
